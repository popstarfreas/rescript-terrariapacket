// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Belt_Option = require("rescript/lib/js/belt_Option.js");
var BitFlags$TerrariaPacket = require("../BitFlags.js");
var PacketType$TerrariaPacket = require("../PacketType.js");
var TileFrameImportant$TerrariaPacket = require("../TileFrameImportant.js");
var ErrorAwarePacketReader$TerrariaPacket = require("../ErrorAwarePacketReader.js");
var ErrorAwarePacketWriter$TerrariaPacket = require("../ErrorAwarePacketWriter.js");
var Packetreader = require("@popstarfreas/packetfactory/packetreader").default;

function parse(payload) {
  var reader = new Packetreader(payload);
  var tileX = ErrorAwarePacketReader$TerrariaPacket.readInt16(reader, "tileX");
  var tileY = ErrorAwarePacketReader$TerrariaPacket.readInt16(reader, "tileY");
  var width = ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "width");
  var height = ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "height");
  var changeType = ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "changeType");
  var tiles = [];
  for(var _x = 0; _x < width; ++_x){
    var column = [];
    for(var _y = 0; _y < height; ++_y){
      var flags1 = BitFlags$TerrariaPacket.fromByte(ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "flags1"));
      var flags2 = BitFlags$TerrariaPacket.fromByte(ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "flags2"));
      var flags3 = ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "flags3");
      var active = BitFlags$TerrariaPacket.flag1(flags1);
      var hasWall = BitFlags$TerrariaPacket.flag3(flags1);
      var hasLiquid = BitFlags$TerrariaPacket.flag4(flags1);
      var wire = BitFlags$TerrariaPacket.flag5(flags1);
      var halfBrick = BitFlags$TerrariaPacket.flag6(flags1);
      var actuator = BitFlags$TerrariaPacket.flag7(flags1);
      var inActive = BitFlags$TerrariaPacket.flag8(flags1);
      var wire2 = BitFlags$TerrariaPacket.flag1(flags2);
      var wire3 = BitFlags$TerrariaPacket.flag2(flags2);
      var color = BitFlags$TerrariaPacket.flag3(flags2) ? ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "color") : undefined;
      var wallColor = BitFlags$TerrariaPacket.flag4(flags2) ? ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "wallColor") : undefined;
      var activeTile;
      if (active) {
        var tileType = ErrorAwarePacketReader$TerrariaPacket.readUInt16(reader, "tileType");
        var frame = TileFrameImportant$TerrariaPacket.isImportant(tileType) ? ({
              x: ErrorAwarePacketReader$TerrariaPacket.readInt16(reader, "frameX"),
              y: ErrorAwarePacketReader$TerrariaPacket.readInt16(reader, "frameY")
            }) : undefined;
        var slope = ((0 + (
              BitFlags$TerrariaPacket.flag5(flags2) ? 1 : 0
            ) | 0) + (
            BitFlags$TerrariaPacket.flag6(flags2) ? 2 : 0
          ) | 0) + (
          BitFlags$TerrariaPacket.flag7(flags2) ? 4 : 0
        ) | 0;
        activeTile = {
          tileType: tileType,
          slope: slope,
          frame: frame
        };
      } else {
        activeTile = undefined;
      }
      var wall = hasWall ? ErrorAwarePacketReader$TerrariaPacket.readUInt16(reader, "wall") : undefined;
      var liquid = hasLiquid ? ({
            liquidValue: ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "liquidValue"),
            liquidType: ErrorAwarePacketReader$TerrariaPacket.readByte(reader, "liquidType")
          }) : undefined;
      var wire4 = BitFlags$TerrariaPacket.flag8(flags2);
      column.push({
            wire: wire,
            halfBrick: halfBrick,
            actuator: actuator,
            inActive: inActive,
            wire2: wire2,
            wire3: wire3,
            wire4: wire4,
            color: color,
            wallColor: wallColor,
            activeTile: activeTile,
            wall: wall,
            liquid: liquid,
            coatHeader: flags3
          });
    }
    tiles.push(column);
  }
  return {
          width: width,
          height: height,
          changeType: changeType,
          tileX: tileX,
          tileY: tileY,
          tiles: tiles
        };
}

function packTile(writer, tile) {
  var flags1 = BitFlags$TerrariaPacket.fromFlags(Belt_Option.isSome(tile.activeTile), false, Belt_Option.isSome(tile.wall), Belt_Option.isSome(tile.liquid), tile.wire, tile.halfBrick, tile.actuator, tile.inActive);
  var flags2 = BitFlags$TerrariaPacket.fromFlags(tile.wire2, tile.wire3, Belt_Option.isSome(tile.color), Belt_Option.isSome(tile.wallColor), Belt_Option.mapWithDefault(tile.activeTile, false, (function (tile) {
              return (tile.slope & 1) === 1;
            })), Belt_Option.mapWithDefault(tile.activeTile, false, (function (tile) {
              return (tile.slope & 2) === 2;
            })), Belt_Option.mapWithDefault(tile.activeTile, false, (function (tile) {
              return (tile.slope & 4) === 4;
            })), tile.wire4);
  ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packByte(writer, BitFlags$TerrariaPacket.toByte(flags1), "flags1"), BitFlags$TerrariaPacket.toByte(flags2), "flags2"), tile.coatHeader, "coatHeader");
  var c = tile.color;
  if (c !== undefined) {
    ErrorAwarePacketWriter$TerrariaPacket.packByte(writer, c, "color");
  }
  var wc = tile.wallColor;
  if (wc !== undefined) {
    ErrorAwarePacketWriter$TerrariaPacket.packByte(writer, wc, "wallColor");
  }
  var at = tile.activeTile;
  if (at !== undefined) {
    ErrorAwarePacketWriter$TerrariaPacket.packUInt16(writer, at.tileType, "tileType");
    if (TileFrameImportant$TerrariaPacket.isImportant(at.tileType)) {
      ErrorAwarePacketWriter$TerrariaPacket.packInt16(ErrorAwarePacketWriter$TerrariaPacket.packInt16(writer, Belt_Option.mapWithDefault(at.frame, 0, (function (frame) {
                      return frame.x;
                    })), "frameX"), Belt_Option.mapWithDefault(at.frame, 0, (function (frame) {
                  return frame.y;
                })), "frameY");
    }
    
  }
  var w = tile.wall;
  if (w !== undefined) {
    ErrorAwarePacketWriter$TerrariaPacket.packUInt16(writer, w, "wall");
  }
  var l = tile.liquid;
  if (l !== undefined) {
    ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packByte(writer, l.liquidValue, "liquidValue"), l.liquidType, "liquidType");
  }
  return writer;
}

function packTiles(writer, tiles) {
  for(var x = 0 ,x_finish = tiles.length; x < x_finish; ++x){
    for(var y = 0 ,y_finish = tiles[x].length; y < y_finish; ++y){
      packTile(writer, tiles[x][y]);
    }
  }
  return writer;
}

function toBuffer(self) {
  return ErrorAwarePacketWriter$TerrariaPacket.data(packTiles(ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packByte(ErrorAwarePacketWriter$TerrariaPacket.packInt16(ErrorAwarePacketWriter$TerrariaPacket.packInt16(ErrorAwarePacketWriter$TerrariaPacket.setType(ErrorAwarePacketWriter$TerrariaPacket.make(), PacketType$TerrariaPacket.toInt("TileSquareSend")), self.tileX, "tileX"), self.tileY, "tileY"), self.width, "width"), self.height, "height"), self.changeType, "changeType"), self.tiles));
}

var Decode = {
  parse: parse
};

var Encode = {
  toBuffer: toBuffer
};

exports.Decode = Decode;
exports.Encode = Encode;
exports.parse = parse;
exports.toBuffer = toBuffer;
/* TileFrameImportant-TerrariaPacket Not a pure module */
